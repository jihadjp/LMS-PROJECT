<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">
<head>
    <title>User Management</title>
</head>
<body>
<div layout:fragment="content">

    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-users mr-2"></i>
                        <span th:text="${pageTitle} ?: 'User Management'">User Management</span>
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Users</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">

            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <i class="fas fa-check-circle mr-2"></i><span th:text="${success}">Success</span>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <i class="fas fa-exclamation-circle mr-2"></i><span th:text="${error}">Error</span>
            </div>

            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 th:text="${totalUsers} ?: '0'">0</h3>
                            <p>Total Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <a th:href="@{/admin/users}" class="small-box-footer">
                            View All <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 th:text="${activeUsers} ?: '0'">0</h3>
                            <p>Active Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <a th:href="@{/admin/users(status='active')}" class="small-box-footer">
                            View Active <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 th:text="${totalInstructors} ?: '0'">0</h3>
                            <p>Instructors</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <a th:href="@{/admin/users/instructors}" class="small-box-footer">
                            View Instructors <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-primary">
                        <div class="inner">
                            <h3 th:text="${totalStudents} ?: '0'">0</h3>
                            <p>Students</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <a th:href="@{/admin/users/students}" class="small-box-footer">
                            View Students <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Users Table Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-table mr-2"></i>All Users
                    </h3>
                    <div class="card-tools">
                        <!-- Search Form -->
                        <form th:action="@{/admin/users}" method="get" class="d-inline-flex">
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <input type="text" name="keyword" class="form-control" 
                                       placeholder="Search by name or email..."
                                       th:value="${searchKeyword}">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <!-- Role Filter Dropdown -->
                        <div class="btn-group btn-group-sm ml-2">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-filter mr-1"></i>
                                <span th:text="${filterRole} ?: 'Filter by Role'">Filter by Role</span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" th:href="@{/admin/users}">All Users</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" th:href="@{/admin/users(role='ADMIN')}">Admins</a>
                                <a class="dropdown-item" th:href="@{/admin/users(role='INSTRUCTOR')}">Instructors</a>
                                <a class="dropdown-item" th:href="@{/admin/users(role='USER')}">Students</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <table id="usersTable" class="table table-bordered table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Avatar</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th style="width: 120px;">Role</th>
                                <th style="width: 100px;">Status</th>
                                <th style="width: 150px;">Created</th>
                                <th style="width: 180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}">
                                <td class="text-center">
                                    <img th:src="@{${user.getPhotosImagePath()}}" 
                                         class="img-circle elevation-2"
                                         alt="User Avatar"
                                         style="width: 40px; height: 40px; object-fit: cover;">
                                </td>
                                <td>
                                    <strong th:text="${user.username}">Username</strong>
                                    <br>
                                    <small class="text-muted" th:if="${user.profession}" 
                                           th:text="${user.profession}">Profession</small>
                                </td>
                                <td>
                                    <a th:href="'mailto:' + ${user.email}" th:text="${user.email}">email@example.com</a>
                                </td>
                                <td>
                                    <span class="badge"
                                          th:classappend="${user.role.name() == 'ADMIN' ? 'badge-danger' : (user.role.name() == 'INSTRUCTOR' ? 'badge-warning' : 'badge-info')}"
                                          th:text="${user.role}">ROLE</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge"
                                          th:classappend="${user.isActive} ? 'badge-success' : 'badge-secondary'"
                                          th:text="${user.isActive} ? 'Active' : 'Inactive'">Status</span>
                                </td>
                                <td>
                                    <small th:text="${#temporals.format(user.createdAt, 'MMM dd, yyyy')}">Jan 01, 2026</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <!-- Toggle Status Button -->
                                        <form th:action="@{/admin/users/toggle-status/{id}(id=${user.id})}" 
                                              method="post" class="d-inline">
                                            <button type="submit" class="btn"
                                                    th:classappend="${user.isActive} ? 'btn-warning' : 'btn-success'"
                                                    th:title="${user.isActive} ? 'Deactivate User' : 'Activate User'"
                                                    onclick="return confirm('Are you sure you want to change this user\\'s status?')">
                                                <i th:class="${user.isActive} ? 'fas fa-user-slash' : 'fas fa-user-check'"></i>
                                            </button>
                                        </form>

                                        <!-- Change Role Dropdown -->
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-info dropdown-toggle" 
                                                    data-toggle="dropdown" title="Change Role">
                                                <i class="fas fa-user-tag"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <h6 class="dropdown-header">Change Role To:</h6>
                                                <form th:action="@{/admin/users/change-role/{id}(id=${user.id})}" method="post">
                                                    <input type="hidden" name="newRole" value="USER">
                                                    <button type="submit" class="dropdown-item"
                                                            th:disabled="${user.role.name() == 'USER'}">
                                                        <i class="fas fa-user mr-2"></i>Student
                                                    </button>
                                                </form>
                                                <form th:action="@{/admin/users/change-role/{id}(id=${user.id})}" method="post">
                                                    <input type="hidden" name="newRole" value="INSTRUCTOR">
                                                    <button type="submit" class="dropdown-item"
                                                            th:disabled="${user.role.name() == 'INSTRUCTOR'}">
                                                        <i class="fas fa-chalkboard-teacher mr-2"></i>Instructor
                                                    </button>
                                                </form>
                                                <div class="dropdown-divider" sec:authorize="hasRole('SUPER_ADMIN')"></div>
                                                <form th:action="@{/admin/users/change-role/{id}(id=${user.id})}" method="post"
                                                      sec:authorize="hasRole('SUPER_ADMIN')">
                                                    <input type="hidden" name="newRole" value="ADMIN">
                                                    <button type="submit" class="dropdown-item text-danger"
                                                            th:disabled="${user.role.name() == 'ADMIN'}">
                                                        <i class="fas fa-user-shield mr-2"></i>Admin
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        <!-- Delete Button -->
                                        <form th:action="@{/admin/users/delete/{id}(id=${user.id})}" 
                                              method="post" class="d-inline">
                                            <button type="submit" class="btn btn-danger" title="Delete User"
                                                    onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Empty State -->
                    <div th:if="${#lists.isEmpty(users)}" class="text-center py-5">
                        <i class="fas fa-users fa-4x text-muted mb-3"></i>
                        <h4>No Users Found</h4>
                        <p class="text-muted">No users match your search criteria.</p>
                        <a th:href="@{/admin/users}" class="btn btn-primary">
                            <i class="fas fa-list mr-2"></i>View All Users
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </section>

</div>

<th:block layout:fragment="script">
    <script th:inline="none">
        $(document).ready(function() {
            // Initialize DataTable
            $('#usersTable').DataTable({
                "responsive": true,
                "autoWidth": false,
                "order": [[ 5, "desc" ]], // Sort by created date descending
                "pageLength": 25,
                "language": {
                    "search": "Quick Filter:",
                    "lengthMenu": "Show _MENU_ users",
                    "info": "Showing _START_ to _END_ of _TOTAL_ users",
                    "emptyTable": "No users found"
                },
                "columnDefs": [
                    { "orderable": false, "targets": [0, 6] } // Disable sorting on avatar and actions columns
                ]
            });
        });
    </script>
</th:block>
</body>
</html>
                                            <label class="custom-control-label" for="emailNotifications">
                                                Email Notifications (Critical only in MVP)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input"
                                                   id="courseApproval" checked disabled>
                                            <label class="custom-control-label" for="courseApproval">
                                                Course Approval Requests
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input"
                                                   id="userRegistration" disabled>
                                            <label class="custom-control-label" for="userRegistration">
                                                New User Registrations (Coming Soon)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Advanced notification settings will be available in future updates
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function() {
            // Password confirmation validation
            $('#confirmPassword').on('keyup', function() {
                const newPassword = $('#newPassword').val();
                const confirmPassword = $(this).val();

                if (newPassword !== confirmPassword) {
                    $('#passwordError').show();
                    $('#changePasswordBtn').prop('disabled', true);
                } else {
                    $('#passwordError').hide();
                    $('#changePasswordBtn').prop('disabled', false);
                }
            });

            // Dark mode toggle
            const darkModeSwitch = $('#darkModeSwitch');
            if ($('body').hasClass('dark-mode')) {
                darkModeSwitch.prop('checked', true);
            }

            darkModeSwitch.on('change', function() {
                $('body').toggleClass('dark-mode');
                const isDark = $('body').hasClass('dark-mode');
                localStorage.setItem('payroll_theme', isDark ? 'dark' : 'light');
            });
        });
    </script>
</th:block>
</body>
</html>